{% extends "base_dashboard.html" %}

{% block dashboard_content %}
<div class="row">
    <!-- Columna principal de noticias -->
    <div class="col-md-9">
        <div class="panel panel-default"> {# Replaced card with panel #}
            <div class="panel-body"> {# Replaced card-body with panel-body #}
                <div class="page-header"> {# BS3 page-header for title section, removed d-flex, justify-content, align-items, mb-4 #}
                    <h3 class="panel-title pull-left"> {# card-title to panel-title, mb-0 removed, pull-left for BS3 #}
                        <i class="fa fa-newspaper text-primary"></i> Noticias
                    </h3>
                    <div class="stats pull-right"> {# pull-right for BS3, removed d-flex gap-4 #}
                        <span class="stat-item" style="margin-left: 15px;"> {# Added style for spacing #}
                            <i class="fa fa-chart-bar text-primary"></i>
                            <span>Total: {{ stats.total }}</span> {# ms-2 removed #}
                        </span>
                        <span class="stat-item" style="margin-left: 15px;">
                            <i class="fa fa-clock text-primary"></i>
                            <span>Últimas 24h: {{ stats.news_last_24h }}</span>
                        </span>
                    </div>
                    <div class="clearfix"></div> {# Clearfix for floats #}
                </div>

                {% if news %}
                <div class="row">
                    {% for item in news %}
                    <div class="col-md-6" style="margin-bottom: 20px;"> {# mb-4 to inline style #}
                        <div class="panel panel-default news-card"> {# card h-100 to panel panel-default #}
                            <div class="panel-body">
                                <div style="margin-bottom: 15px;"> {# mb-3 to inline style, removed d-flex etc. #}
                                    <span class="text-capitalize source-badge">{{ item.source }}</span>
                                    <span class="country-badge label" style="background-color: {% if item.country == '.ar' %}#74ACDF{% elif item.country == '.cl' %}#D52B1E{% elif item.country == '.uy' %}#FCD116{% elif item.country == '.py' %}#D80027{% elif item.country == '.bo' %}#007934{% elif item.country == '.mx' %}#006847{% elif item.country == '.co' %}#FCD116{% elif item.country == '.pe' %}#D91023{% elif item.country == '.ec' %}#FFD100{% elif item.country == '.ve' %}#CF142B{% else %}#6C757D{% endif %}; color: white; float: right;"> {# px-2 py-1 rounded-pill to label and float #}
                                        {% if item.country == '.ar' %}🇦🇷 Argentina
                                        {% elif item.country == '.cl' %}🇨🇱 Chile
                                        {% elif item.country == '.uy' %}🇺🇾 Uruguay
                                        {% elif item.country == '.py' %}🇵🇾 Paraguay
                                        {% elif item.country == '.bo' %}🇧🇴 Bolivia
                                        {% elif item.country == '.mx' %}🇲🇽 México
                                        {% elif item.country == '.co' %}🇨🇴 Colombia
                                        {% elif item.country == '.pe' %}🇵🇪 Perú
                                        {% elif item.country == '.ec' %}🇪🇨 Ecuador
                                        {% elif item.country == '.ve' %}🇻🇪 Venezuela
                                        {% else %}🌎 Internacional
                                        {% endif %}
                                    </span>
                                    <div class="clearfix"></div>
                                </div>
                                
                                <h4 style="margin-bottom: 15px;"> {# h6 card-title mb-3 to h4 with style #}
                                    <a href="{{ item.url }}" target="_blank" class="news-title">{{ item.title }}</a> {# text-decoration-none is BS5, default link style in BS3 #}
                                </h4>
                                
                                <p class="text-muted small" style="margin-bottom: 15px;">{{ item.content }}</p> {# card-text removed, mb-3 to style #}
                                
                                <div> {# Removed d-flex etc, mt-auto. Elements will stack or use pull-right/left #}
                                    <span class="label label-primary">{{ item.keywords }}</span> {# badge bg-primary to label label-primary #}
                                    <small class="text-muted pull-right"> {# pull-right for BS3 #}
                                        <i class="fa fa-clock-o"></i> {# far fa-clock to fa fa-clock-o, me-1 removed #}
                                        {{ item.published_date.strftime('%d/%m/%Y %H:%M') if item.published_date else 'Fecha no disponible' }}
                                    </small>
                                    <div class="clearfix"></div>
                                </div>
                            </div>
                            <div class="panel-footer" style="background-color: transparent;"> {# card-footer bg-transparent to panel-footer with style #}
                                <a href="{{ item.url }}" target="_blank" class="btn btn-xs btn-default btn-block"> {# btn-sm btn-outline-primary w-100 to btn-xs btn-default btn-block #}
                                    <i class="fa fa-external-link-alt"></i> Leer más {# me-1 removed #}
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if pagination.pages > 1 %}
                <nav aria-label="Navegación de páginas" class="text-center" style="margin-top: 20px;"> {# mt-4 to style, text-center for pagination #}
                    <ul class="pagination"> {# justify-content-center mb-0 removed #}
                        <li class="{% if not pagination.has_prev %}disabled{% endif %}">
                            <a href="{{ url_for('main.feed_new', page=pagination.prev_num) if pagination.has_prev else '#' }}">
                                <i class="fa fa-chevron-left"></i>
                            </a>
                        </li>
                        
                        {% for page in pagination.iter_pages() %}
                            {% if page %}
                                <li class="{% if page == pagination.page %}active{% endif %}">
                                    <a href="{{ url_for('main.feed_new', page=page) }}">{{ page }}</a>
                                </li>
                            {% else %}
                                <li class="disabled"><span>...</span></li>
                            {% endif %}
                        {% endfor %}
                        
                        <li class="{% if not pagination.has_next %}disabled{% endif %}">
                            <a href="{{ url_for('main.feed_new', page=pagination.next_num) if pagination.has_next else '#' }}">
                                <i class="fa fa-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
                {% endif %}
                {% else %}
                <div class="text-center text-muted" style="padding-top: 50px; padding-bottom: 50px;"> {# py-5 to inline style #}
                    <i class="fa fa-newspaper-o fa-3x" style="margin-bottom: 15px;"></i> {# fas fa-newspaper to fa fa-newspaper-o, mb-3 to style #}
                    <p>No hay noticias disponibles en este momento.</p> {# mb-0 removed #}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Columna lateral con estadísticas -->
    <div class="col-md-3">
        <div class="panel panel-default stats-card" style="position: sticky; top: 20px;"> {# card to panel panel-default #}
            <div class="panel-body"> {# card-body to panel-body #}
                <h4 class="panel-title" style="margin-bottom: 20px;"> {# h5 card-title mb-4 to h4 panel-title with style #}
                    <i class="fa fa-pie-chart text-primary"></i> Estadísticas por País {# fas to fa #}
                </h4>
                
                <!-- Gráfico de dona -->
                <div style="height: 200px; margin-bottom: 1rem;">
                    <canvas id="countryChart"></canvas>
                </div>
                
                <!-- Lista de países -->
                <div class="country-stats" style="max-height: 400px; overflow-y: auto;">
                    <div class="country-stat-item clearfix" style="margin-bottom: 10px;"> {# d-flex etc to clearfix and margin style #}
                        <div><span class="flag">🇦🇷</span> Argentina</div>
                        <span class="label label-primary pull-right">{{ stats.by_country['.ar']|default(0) }}</span> {# badge bg-primary to label label-primary pull-right #}
                    </div>
                    <div class="country-stat-item clearfix" style="margin-bottom: 10px;">
                        <div><span class="flag">🇨🇱</span> Chile</div>
                        <span class="label label-primary pull-right">{{ stats.by_country['.cl']|default(0) }}</span>
                    </div>
                    <div class="country-stat-item clearfix" style="margin-bottom: 10px;">
                        <div><span class="flag">🇺🇾</span> Uruguay</div>
                        <span class="label label-primary pull-right">{{ stats.by_country['.uy']|default(0) }}</span>
                    </div>
                    <div class="country-stat-item clearfix" style="margin-bottom: 10px;">
                        <div><span class="flag">🇵🇾</span> Paraguay</div>
                        <span class="label label-primary pull-right">{{ stats.by_country['.py']|default(0) }}</span>
                    </div>
                    <div class="country-stat-item clearfix" style="margin-bottom: 10px;">
                        <div><span class="flag">🇧🇴</span> Bolivia</div>
                        <span class="label label-primary pull-right">{{ stats.by_country['.bo']|default(0) }}</span>
                    </div>
                    <div class="country-stat-item clearfix" style="margin-bottom: 10px;">
                        <div><span class="flag">🇲🇽</span> México</div>
                        <span class="label label-primary pull-right">{{ stats.by_country['.mx']|default(0) }}</span>
                    </div>
                    <div class="country-stat-item clearfix" style="margin-bottom: 10px;">
                        <div><span class="flag">🇨🇴</span> Colombia</div>
                        <span class="label label-primary pull-right">{{ stats.by_country['.co']|default(0) }}</span>
                    </div>
                    <div class="country-stat-item clearfix" style="margin-bottom: 10px;">
                        <div><span class="flag">🇵🇪</span> Perú</div>
                        <span class="label label-primary pull-right">{{ stats.by_country['.pe']|default(0) }}</span>
                    </div>
                    <div class="country-stat-item clearfix" style="margin-bottom: 10px;">
                        <div><span class="flag">🇪🇨</span> Ecuador</div>
                        <span class="label label-primary pull-right">{{ stats.by_country['.ec']|default(0) }}</span>
                    </div>
                    <div class="country-stat-item clearfix" style="margin-bottom: 10px;">
                        <div><span class="flag">🇻🇪</span> Venezuela</div>
                        <span class="label label-primary pull-right">{{ stats.by_country['.ve']|default(0) }}</span>
                    </div>
                    <div class="country-stat-item clearfix">
                        <div><span class="flag">🌎</span> Internacional</div>
                        <span class="label label-primary pull-right">{{ stats.by_country['other']|default(0) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script para el gráfico -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('countryChart').getContext('2d');
    
    // Colores para cada país
    const colors = {
        '.ar': '#74ACDF',
        '.cl': '#D52B1E',
        '.uy': '#FCD116',
        '.py': '#D80027',
        '.bo': '#007934',
        '.mx': '#006847',
        '.co': '#FCD116',
        '.pe': '#D91023',
        '.ec': '#FFD100',
        '.ve': '#CF142B',
        'other': '#6C757D'
    };
    
    // Función para obtener el nombre del país
    function getCountryName(code) {
        const countries = {
            '.ar': '🇦🇷 Argentina',
            '.cl': '🇨🇱 Chile',
            '.uy': '🇺🇾 Uruguay',
            '.py': '🇵🇾 Paraguay',
            '.bo': '🇧🇴 Bolivia',
            '.mx': '🇲🇽 México',
            '.co': '🇨🇴 Colombia',
            '.pe': '🇵🇪 Perú',
            '.ec': '🇪🇨 Ecuador',
            '.ve': '🇻🇪 Venezuela',
            'other': '🌎 Internacional'
        };
        return countries[code] || countries['other'];
    }
    
    // Preparar datos para el gráfico
    const countryData = {{ stats.by_country|tojson }};
    const labels = Object.keys(countryData);
    const data = Object.values(countryData);
    const backgroundColors = labels.map(country => colors[country] || colors['other']);
    
    // Crear el gráfico
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels.map(getCountryName),
            datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                borderColor: 'white',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { // In Chart.js 2.x, legend and tooltip are directly under options, not plugins
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            return `${label}: ${value} noticias`;
                        }
                    }
                }
            }
        }
    });
});
</script>

<style>
.news-card {
    /* transition: transform 0.2s; BS3 doesn't have transform utilities by default */
    border: 1px solid #ddd; /* Default panel border */
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.news-card:hover {
    /* transform: translateY(-5px); */
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.source-badge {
    font-weight: 500;
    color: #777; /* BS3 text-muted */
    text-transform: capitalize;
}
.country-badge {
    font-size: 0.85em; /* BS3 label is a bit larger */
    font-weight: bold; /* BS3 label is bold */
    white-space: nowrap;
    /* padding: .2em .6em .3em; BS3 label default padding */
}
.news-title {
    color: #337ab7; /* BS3 default link color */
    text-decoration: none;
}
.news-title:hover {
    color: #23527c; /* BS3 default link hover color */
    text-decoration: underline;
}

/* Estilos para la tarjeta de estadísticas */
.stats-card {
    /* height: calc(100vh - 40px); BS5 calc, use JS or ensure parent heights are set for sticky to work */
    overflow: hidden; /* This is fine */
}

.stats-card .panel-body { /* Changed from card-body */
    /* display: flex; flex-direction: column; height: 100%; BS5 flex, use block elements or JS for height */
}

.country-stats {
    /* scrollbar-width: thin; scrollbar-color: #6c757d #f8f9fa; Firefox specific */
    overflow-y: auto; /* This is fine */
}

/* Webkit scrollbar styles are fine */
.country-stats::-webkit-scrollbar {
    width: 6px;
}

.country-stats::-webkit-scrollbar-track {
    background: #f8f9fa;
}

.country-stats::-webkit-scrollbar-thumb {
    background-color: #6c757d;
    border-radius: 3px;
}

.country-stat-item {
    padding: 5px; /* BS3 roughly .5rem */
    border-radius: 3px; /* BS3 default */
    /* transition: background-color 0.2s; CSS3 fine */
}

.country-stat-item:hover {
    background-color: #f5f5f5; /* BS3 default hover */
}

.flag {
    margin-right: 5px; /* BS3 roughly .5rem */
}
.panel-footer { /* Ensure footer is styled like Poncho panel-footer */
    background-color: #f5f5f5;
    border-top: 1px solid #ddd;
}
</style>
{% endblock %}
