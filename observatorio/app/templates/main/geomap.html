{% extends "base_dashboard.html" %}

{% block extra_css %}
<link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
<style>
    .map-container {
        display: flex;
        gap: 20px;
        height: calc(100vh - 100px);
        margin-top: 20px;
    }
    
    .map-area {
        flex: 1;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 15px;
        position: relative;
    }
    
    .metrics-area {
        width: 300px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 15px;
        overflow-y: auto;
    }
    
    #map {
        width: 100%;
        height: 100%;
        border-radius: 4px;
    }
    
    .marker-popup {
        max-width: 300px;
        padding: 10px;
    }
    
    .marker-popup h5 {
        margin: 0 0 8px 0;
        color: #2c3e50;
    }
    
    .marker-popup p {
        margin: 0 0 5px 0;
        font-size: 0.9em;
        color: #34495e;
    }
    
    .filter-section {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .filter-section h5 {
        margin-bottom: 10px;
        color: #2c3e50;
        font-size: 1rem;
    }

    .form-control {
        margin-bottom: 10px;
    }

    .page-header {
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    .page-header h1 {
        font-size: 1.5rem;
        color: #2c3e50;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .page-header p {
        color: #7f8c8d;
        margin: 5px 0 0 0;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        padding: 8px 15px;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background-color: #3498db;
        border-color: #3498db;
        color: white;
    }

    .btn-secondary {
        background-color: #95a5a6;
        border-color: #95a5a6;
        color: white;
    }

    .btn:hover {
        opacity: 0.9;
    }

    .mb-2 {
        margin-bottom: 0.5rem;
    }

    .w-100 {
        width: 100%;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="page-header">
    <h1>
        <i class="fas fa-map-marked-alt"></i>
        Visualización Geográfica
    </h1>
    <p>Visualización geográfica de noticias sobre drogas sintéticas en Sudamérica</p>
</div>

<div class="map-container">
    <div class="map-area">
        <div id="map"></div>
    </div>
    <div class="metrics-area">
        <div class="filter-section">
            <h5>FILTROS</h5>
            <div class="date-filters">
                <h5>Rango de Fechas</h5>
                <input type="text" id="start_date" class="form-control" placeholder="Fecha inicial">
                <input type="text" id="end_date" class="form-control" placeholder="Fecha final">
            </div>
            <div class="country-filter">
                <h5>País</h5>
                <select id="country_filter" class="form-control">
                    <option value="">Todos los países</option>
                    {% for country in countries %}
                    <option value="{{ country.code }}">{{ country.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button id="apply_filters" class="btn btn-primary w-100 mb-2">
                <i class="fas fa-filter"></i> Aplicar Filtros
            </button>
            <button id="clear_filters" class="btn btn-secondary w-100">
                <i class="fas fa-times"></i> Limpiar Filtros
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
<script>
let map;
let markers = [];

document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando mapa...');
    
    // Inicializar datepickers
    flatpickr("#start_date", {
        locale: "es",
        dateFormat: "Y-m-d",
        maxDate: "today"
    });

    flatpickr("#end_date", {
        locale: "es",
        dateFormat: "Y-m-d",
        maxDate: "today"
    });

    // Inicializar mapa
    mapboxgl.accessToken = '{{ mapbox_token }}';
    console.log('Token configurado:', !!mapboxgl.accessToken);

    try {
        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            center: [-58.3816, -34.6037],
            zoom: 4
        });

        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        map.addControl(new mapboxgl.FullscreenControl(), 'top-right');

        map.on('load', function() {
            console.log('Mapa cargado, cargando ubicaciones...');
            loadLocations();
        });
    } catch (error) {
        console.error('Error al inicializar el mapa:', error);
    }
});

function loadLocations(filters = {}) {
    console.log('Cargando ubicaciones con filtros:', filters);
    
    const params = new URLSearchParams();
    if (filters.start_date) params.append('start_date', filters.start_date);
    if (filters.end_date) params.append('end_date', filters.end_date);
    if (filters.country) params.append('country', filters.country);

    fetch(`/api/news_locations?${params.toString()}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Datos recibidos:', data);
            
            // Limpiar marcadores existentes
            markers.forEach(marker => marker.remove());
            markers = [];

            if (data.locations && data.locations.length > 0) {
                const bounds = new mapboxgl.LngLatBounds();

                data.locations.forEach(location => {
                    const popup = new mapboxgl.Popup({ offset: 25 })
                        .setHTML(`
                            <div class="marker-popup">
                                <h5>${location.title}</h5>
                                <p>${location.description}</p>
                                <p><small>
                                    <i class="far fa-calendar-alt"></i>
                                    Fecha: ${location.date}
                                </small></p>
                                <p><small>
                                    <i class="fas fa-map-marker-alt"></i>
                                    ${location.location_name}
                                </small></p>
                                <a href="${location.url}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="fas fa-external-link-alt"></i>
                                    Ver noticia
                                </a>
                            </div>
                        `);

                    const marker = new mapboxgl.Marker({ color: "#FF0000" })
                        .setLngLat([location.longitude, location.latitude])
                        .setPopup(popup)
                        .addTo(map);

                    markers.push(marker);
                    bounds.extend([location.longitude, location.latitude]);
                });

                map.fitBounds(bounds, { padding: 50 });
            }
        })
        .catch(error => {
            console.error('Error al cargar ubicaciones:', error);
            alert('Error al cargar las ubicaciones. Por favor, intente nuevamente.');
        });
}

// Event listeners para los filtros
document.getElementById('apply_filters').addEventListener('click', function() {
    const filters = {
        start_date: document.getElementById('start_date').value,
        end_date: document.getElementById('end_date').value,
        country: document.getElementById('country_filter').value
    };
    loadLocations(filters);
});

document.getElementById('clear_filters').addEventListener('click', function() {
    document.getElementById('start_date').value = '';
    document.getElementById('end_date').value = '';
    document.getElementById('country_filter').value = '';
    loadLocations();
});
</script>
{% endblock %}
