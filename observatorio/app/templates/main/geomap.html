{% extends "base_dashboard.html" %}

{% block extra_css %}
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
<style>
    .main-content {
        padding: 0 !important;
        position: relative;
        height: 100vh;
        margin: 0;
    }
    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
        margin: 0;
    }
    .mapboxgl-popup {
        max-width: 400px;
    }
    .news-popup {
        max-width: 350px;
        padding: 15px;
        background: #1f1f1f;
        color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .news-popup h4 {
        margin: 0 0 12px 0;
        color: #ffffff;
        font-size: 18px;
        font-weight: 600;
        line-height: 1.3;
        border-bottom: 2px solid #cc0000;
        padding-bottom: 8px;
    }
    .news-popup .news-item {
        margin-bottom: 20px;
        border-bottom: 1px solid #333;
        padding-bottom: 15px;
    }
    .news-popup .news-item:last-child {
        margin-bottom: 0;
        border-bottom: none;
    }
    .news-popup p {
        margin: 8px 0;
        line-height: 1.4;
    }
    .news-popup .source {
        font-size: 0.9em;
        color: #aaa;
        margin: 8px 0;
        display: flex;
        align-items: center;
    }
    .news-popup .source::before {
        content: "üìç";
        margin-right: 5px;
    }
    .news-popup .date {
        font-size: 0.85em;
        color: #888;
        font-style: italic;
    }
    .news-popup a {
        display: inline-block;
        color: #ffffff;
        text-decoration: none;
        background-color: #cc0000;
        padding: 6px 12px;
        border-radius: 4px;
        margin-top: 10px;
        transition: background-color 0.2s;
    }
    .news-popup a:hover {
        background-color: #ff0000;
        text-decoration: none;
    }
    .mapboxgl-popup-content {
        background: #1f1f1f;
        color: #ffffff;
        border-radius: 8px;
        padding: 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    .mapboxgl-popup-close-button {
        color: #ffffff;
        font-size: 20px;
        padding: 5px 10px;
        right: 5px;
        top: 5px;
    }
    .mapboxgl-popup-tip {
        border-top-color: #1f1f1f !important;
    }
    .filter-panel {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 15px;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        z-index: 1;
        max-width: 300px;
    }
    .filter-panel h3 {
        margin: 0 0 15px 0;
        font-size: 16px;
        color: #333;
    }
    .filter-group {
        margin-bottom: 15px;
    }
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
        color: #666;
    }
    .filter-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    .filter-actions {
        display: flex;
        gap: 10px;
    }
    .filter-button {
        flex: 1;
        padding: 8px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .apply-button {
        background-color: #0066cc;
        color: white;
    }
    .apply-button:hover {
        background-color: #0052a3;
    }
    .reset-button {
        background-color: #f0f0f0;
        color: #333;
    }
    .reset-button:hover {
        background-color: #e0e0e0;
    }
    .view-toggle-group {
        position: absolute;
        top: 10px;
        right: 50px;
        background: white;
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        z-index: 1;
        display: flex;
        gap: 8px;
    }
    .view-toggle {
        background: white;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid #ddd;
        font-size: 14px;
        transition: all 0.2s;
    }
    .view-toggle:hover {
        background-color: #f0f0f0;
    }
    .view-toggle.active {
        background-color: #0066cc;
        color: white;
        border-color: #0052a3;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="main-content">
    <div id="map"></div>

    <!-- Panel de filtros -->
    <div class="filter-panel">
        <h3>Filtros</h3>
        <div class="filter-group">
            <label for="startDate">Fecha Inicio:</label>
            <input type="date" id="startDate" name="startDate">
        </div>
        <div class="filter-group">
            <label for="endDate">Fecha Fin:</label>
            <input type="date" id="endDate" name="endDate">
        </div>
        <div class="filter-actions">
            <button class="filter-button apply-button" onclick="applyFilters()">Aplicar</button>
            <button class="filter-button reset-button" onclick="resetFilters()">Resetear</button>
        </div>
    </div>

    <!-- Grupo de botones para cambiar la visualizaci√≥n -->
    <div class="view-toggle-group">
        <button id="markersToggle" class="view-toggle active" onclick="changeView('markers')">Marcadores</button>
        <button id="heatmapToggle" class="view-toggle" onclick="changeView('heatmap')">Mapa de Calor</button>
        <button id="bubblesToggle" class="view-toggle" onclick="changeView('bubbles')">Mapa de Burbujas</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
<script>
    // Inicializar variables globales
    let map;
    let markers = [];
    let heatmapLayer = null;
    let bubbleLayer = null;
    let currentView = 'markers';

    // Inicializar mapa
    mapboxgl.accessToken = '{{ mapbox_token }}';
    map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v11',
        center: [-64.0, -34.0],  // Centro en Argentina
        zoom: 4,
        transformRequest: (url, resourceType) => {
            if (resourceType === 'Source' || resourceType === 'Tile') {
                return {
                    url: url,
                    headers: {
                        'Accept-Language': 'es'  // Forzar espa√±ol
                    }
                };
            }
        }
    });

    // Agregar el control de navegaci√≥n
    map.addControl(new mapboxgl.NavigationControl());

    // Esperar a que el mapa cargue
    map.on('load', function() {
        // Personalizar el texto de las Malvinas
        map.setLayoutProperty('country-label', 'text-field', [
            'match',
            ['get', 'name_en'],
            'Falkland Islands (Islas Malvinas)',
            'Islas Malvinas',
            ['get', 'name']
        ]);

        // Cargar los marcadores de noticias
        loadNewsMarkers();
    });

    // Funci√≥n para cargar y mostrar noticias
    async function loadNewsMarkers(filters = {}) {
        try {
            // Limpiar marcadores existentes
            clearMarkers();

            let url = '/api/news/locations';  
            if (filters.startDate || filters.endDate) {
                const params = new URLSearchParams();
                if (filters.startDate) params.append('start_date', filters.startDate);
                if (filters.endDate) params.append('end_date', filters.endDate);
                url += '?' + params.toString();
            }

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const newsLocations = await response.json();
            
            if (!Array.isArray(newsLocations)) {
                console.error('La respuesta no es un array:', newsLocations);
                return;
            }

            if (newsLocations.length === 0) {
                console.log('No se encontraron ubicaciones');
                return;
            }

            console.log('Ubicaciones encontradas:', newsLocations.length);

            // Agrupar noticias por ubicaci√≥n
            const locationGroups = {};
            newsLocations.forEach(loc => {
                if (!loc.latitude || !loc.longitude) {
                    console.warn('Ubicaci√≥n sin coordenadas:', loc);
                    return;
                }
                const key = `${loc.latitude},${loc.longitude}`;
                if (!locationGroups[key]) {
                    locationGroups[key] = [];
                }
                locationGroups[key].push(loc);
            });

            // Crear marcadores para cada grupo de ubicaciones
            Object.entries(locationGroups).forEach(([coords, locations]) => {
                const [lat, lng] = coords.split(',').map(Number);
                
                // Crear el contenido del popup
                let popupContent = '<div class="news-popup">';
                locations.forEach(loc => {
                    const date = loc.news.published_date ? new Date(loc.news.published_date).toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'No disponible';
                    popupContent += `
                        <div class="news-item">
                            <h4>${loc.news.title}</h4>
                            <p>${loc.news.snippet || ''}</p>
                            <p class="source">Ubicaci√≥n: ${loc.location_name}</p>
                            <p class="source">Fuente: ${loc.news.source || 'No disponible'}</p>
                            <p class="date">Publicado el ${date}</p>
                            ${loc.news.link ? `<a href="${loc.news.link}" target="_blank">Leer noticia completa ‚Üí</a>` : ''}
                        </div>
                    `;
                });
                popupContent += '</div>';

                // Crear marcador
                const marker = new mapboxgl.Marker({
                    color: "#cc0000",  // Color rojo
                    scale: 0.9  // Tama√±o ligeramente m√°s grande
                })
                .setLngLat([lng, lat])
                .setPopup(new mapboxgl.Popup().setHTML(popupContent))
                .addTo(map);

                markers.push(marker);
            });

            // Despu√©s de crear todos los marcadores, preparar datos para el mapa de calor
            const points = Object.entries(locationGroups).map(([coords, locations]) => {
                const [lat, lng] = coords.split(',').map(Number);
                return {
                    'type': 'Feature',
                    'properties': {
                        'intensity': locations.length // La intensidad se basa en el n√∫mero de noticias
                    },
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [lng, lat]
                    }
                };
            });

            // Almacenar los datos del mapa de calor
            window.heatmapData = {
                'type': 'FeatureCollection',
                'features': points
            };

        } catch (error) {
            console.error('Error loading news markers:', error);
        }
    }

    function clearMarkers() {
        markers.forEach(marker => marker.remove());
        markers = [];
    }

    function applyFilters() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        loadNewsMarkers({
            startDate: startDate,
            endDate: endDate
        });
    }

    function resetFilters() {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        loadNewsMarkers();
    }

    function clearLayers() {
        // Limpiar mapa de calor si existe
        if (heatmapLayer) {
            map.removeLayer('heatmap-layer');
            map.removeSource('heatmap-points');
            heatmapLayer = null;
        }
        
        // Limpiar mapa de burbujas si existe
        if (bubbleLayer) {
            map.removeLayer('bubble-layer');
            map.removeSource('bubble-points');
            bubbleLayer = null;
        }
    }

    function updateButtonStates(activeView) {
        document.querySelectorAll('.view-toggle').forEach(button => {
            button.classList.remove('active');
        });
        document.getElementById(`${activeView}Toggle`).classList.add('active');
    }

    function showMarkers(show) {
        markers.forEach(marker => {
            marker.getElement().style.display = show ? 'block' : 'none';
        });
    }

    function createHeatmap() {
        if (!window.heatmapData) return;
        
        map.addSource('heatmap-points', {
            'type': 'geojson',
            'data': window.heatmapData
        });

        map.addLayer({
            'id': 'heatmap-layer',
            'type': 'heatmap',
            'source': 'heatmap-points',
            'paint': {
                'heatmap-weight': [
                    'interpolate',
                    ['linear'],
                    ['get', 'intensity'],
                    1, 0.5,
                    5, 1
                ],
                'heatmap-intensity': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    0, 1,
                    9, 3
                ],
                'heatmap-color': [
                    'interpolate',
                    ['linear'],
                    ['heatmap-density'],
                    0, 'rgba(33,102,172,0)',
                    0.2, 'rgba(103,169,207,0.5)',
                    0.4, 'rgba(209,229,240,0.6)',
                    0.6, 'rgba(253,219,199,0.7)',
                    0.8, 'rgba(239,138,98,0.8)',
                    1, 'rgba(178,24,43,0.9)'
                ],
                'heatmap-radius': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    0, 20,
                    9, 40
                ],
                'heatmap-opacity': 0.8
            }
        });
        heatmapLayer = true;
    }

    function createBubbleMap() {
        if (!window.heatmapData) return;

        map.addSource('bubble-points', {
            'type': 'geojson',
            'data': window.heatmapData
        });

        map.addLayer({
            'id': 'bubble-layer',
            'type': 'circle',
            'source': 'bubble-points',
            'paint': {
                'circle-radius': [
                    'interpolate',
                    ['linear'],
                    ['get', 'intensity'],
                    1, 10,
                    5, 20,
                    10, 30
                ],
                'circle-color': '#007cbf',
                'circle-opacity': 0.6,
                'circle-stroke-width': 1,
                'circle-stroke-color': '#fff'
            }
        });
        bubbleLayer = true;
    }

    function changeView(viewType) {
        if (currentView === viewType) return;
        
        currentView = viewType;
        clearLayers();
        updateButtonStates(viewType);

        switch(viewType) {
            case 'markers':
                showMarkers(true);
                break;
            case 'heatmap':
                showMarkers(false);
                createHeatmap();
                break;
            case 'bubbles':
                showMarkers(false);
                createBubbleMap();
                break;
        }
    }
</script>
{% endblock %}
