{% extends "base_dashboard.html" %}

{% block extra_css %}
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
<style>
    .main-content {
        padding: 0 !important;
        position: relative;
        height: 100vh;
        margin: 0;
    }
    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
        margin: 0;
    }
    .mapboxgl-popup {
        max-width: 400px;
    }
    .news-popup {
        padding: 10px;
    }
    .news-popup h4 {
        margin: 0 0 10px 0;
        color: #333;
    }
    .news-popup p {
        margin: 5px 0;
        font-size: 0.9em;
    }
    .news-popup a {
        color: #0066cc;
        text-decoration: none;
    }
    .news-popup a:hover {
        text-decoration: underline;
    }
    .news-popup .source {
        color: #666;
        font-size: 0.8em;
    }
    .news-popup .date {
        color: #666;
        font-size: 0.8em;
    }
    .filter-panel {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 15px;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        z-index: 1;
        max-width: 300px;
    }
    .filter-panel h3 {
        margin: 0 0 15px 0;
        font-size: 16px;
        color: #333;
    }
    .filter-group {
        margin-bottom: 15px;
    }
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
        color: #666;
    }
    .filter-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    .filter-actions {
        display: flex;
        gap: 10px;
    }
    .filter-button {
        flex: 1;
        padding: 8px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .apply-button {
        background-color: #0066cc;
        color: white;
    }
    .apply-button:hover {
        background-color: #0052a3;
    }
    .reset-button {
        background-color: #f0f0f0;
        color: #333;
    }
    .reset-button:hover {
        background-color: #e0e0e0;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="main-content">
    <div class="filter-panel">
        <h3>Filtros</h3>
        <div class="filter-group">
            <label for="start-date">Fecha inicial:</label>
            <input type="date" id="start-date" name="start-date">
        </div>
        <div class="filter-group">
            <label for="end-date">Fecha final:</label>
            <input type="date" id="end-date" name="end-date">
        </div>
        <div class="filter-actions">
            <button class="filter-button apply-button" onclick="applyFilters()">Aplicar</button>
            <button class="filter-button reset-button" onclick="resetFilters()">Restablecer</button>
        </div>
    </div>
    <div id="map"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
<script>
    let map;
    let markers = [];

    document.addEventListener('DOMContentLoaded', function() {
        try {
            mapboxgl.accessToken = '{{ mapbox_token }}';
            console.log('Mapbox Token:', mapboxgl.accessToken); // Para debug
            
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [-58.3816, -34.6037], // Buenos Aires
                zoom: 4
            });

            map.addControl(new mapboxgl.NavigationControl(), 'top-right');
            map.addControl(new mapboxgl.ScaleControl(), 'bottom-right');

            // Esperar a que el mapa se cargue antes de agregar marcadores
            map.on('load', function() {
                loadNewsMarkers();
            });

        } catch (error) {
            console.error('Error initializing map:', error);
        }
    });

    // Funci칩n para cargar y mostrar noticias
    async function loadNewsMarkers(filters = {}) {
        try {
            // Limpiar marcadores existentes
            clearMarkers();

            let url = '/api/news_locations';  
            if (filters.startDate || filters.endDate) {
                const params = new URLSearchParams();
                if (filters.startDate) params.append('start_date', filters.startDate);
                if (filters.endDate) params.append('end_date', filters.endDate);
                url += '?' + params.toString();
            }

            const response = await fetch(url);
            const data = await response.json();
            const newsLocations = data.locations;  
            
            if (!newsLocations) {
                console.error('No se encontraron ubicaciones');
                return;
            }

            // Agrupar noticias por ubicaci칩n
            const locationGroups = {};
            newsLocations.forEach(loc => {
                const key = `${loc.latitude},${loc.longitude}`;
                if (!locationGroups[key]) {
                    locationGroups[key] = [];
                }
                locationGroups[key].push(loc);
            });

            // Crear marcadores para cada grupo de ubicaciones
            Object.entries(locationGroups).forEach(([coords, locations]) => {
                const [lat, lng] = coords.split(',').map(Number);
                
                // Crear el contenido del popup
                let popupContent = '<div class="news-popup">';
                locations.forEach(loc => {
                    popupContent += `
                        <div class="news-item">
                            <h4>${loc.title}</h4>
                            <p>${loc.description}</p>
                            <p class="source">Ubicaci칩n: ${loc.location_name}</p>
                            <p class="date">Fecha: ${loc.date || 'No disponible'}</p>
                            ${loc.url ? `<a href="${loc.url}" target="_blank">Leer m치s</a>` : ''}
                        </div>
                        <hr>
                    `;
                });
                popupContent += '</div>';

                // Crear marcador
                const marker = new mapboxgl.Marker({
                    color: "#0066cc"
                })
                .setLngLat([lng, lat])
                .setPopup(new mapboxgl.Popup().setHTML(popupContent))
                .addTo(map);

                markers.push(marker);
            });

        } catch (error) {
            console.error('Error loading news markers:', error);
        }
    }

    function clearMarkers() {
        markers.forEach(marker => marker.remove());
        markers = [];
    }

    function applyFilters() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        loadNewsMarkers({
            startDate: startDate,
            endDate: endDate
        });
    }

    function resetFilters() {
        document.getElementById('start-date').value = '';
        document.getElementById('end-date').value = '';
        loadNewsMarkers();
    }
</script>
{% endblock %}
