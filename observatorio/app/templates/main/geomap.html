{% extends "base_dashboard.html" %}

{% block extra_css %}
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
<style>
    .main-content {
        padding: 0 !important;
        position: relative;
        height: 100vh;
        margin: 0;
    }
    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
        margin: 0;
    }
    .mapboxgl-popup {
        max-width: 400px;
    }
    .news-popup {
        max-width: 300px;
        padding: 10px;
        background: #1f1f1f;
        color: #ffffff;
    }
    .news-popup h4 {
        margin: 0 0 10px 0;
        color: #ffffff;
    }
    .news-popup .news-item {
        margin-bottom: 15px;
        border-bottom: 1px solid #333;
        padding-bottom: 15px;
    }
    .news-popup .news-item:last-child {
        margin-bottom: 0;
        border-bottom: none;
    }
    .news-popup .source {
        font-size: 0.9em;
        color: #888;
        margin: 5px 0;
    }
    .news-popup .date {
        font-size: 0.8em;
        color: #666;
    }
    .news-popup a {
        color: #4a9eff;
        text-decoration: none;
    }
    .news-popup a:hover {
        text-decoration: underline;
    }
    .mapboxgl-popup-content {
        background: #1f1f1f;
        color: #ffffff;
        border-radius: 8px;
    }
    .mapboxgl-popup-close-button {
        color: #ffffff;
    }
    .mapboxgl-popup-tip {
        border-top-color: #1f1f1f !important;
    }
    .filter-panel {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 15px;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        z-index: 1;
        max-width: 300px;
    }
    .filter-panel h3 {
        margin: 0 0 15px 0;
        font-size: 16px;
        color: #333;
    }
    .filter-group {
        margin-bottom: 15px;
    }
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
        color: #666;
    }
    .filter-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    .filter-actions {
        display: flex;
        gap: 10px;
    }
    .filter-button {
        flex: 1;
        padding: 8px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .apply-button {
        background-color: #0066cc;
        color: white;
    }
    .apply-button:hover {
        background-color: #0052a3;
    }
    .reset-button {
        background-color: #f0f0f0;
        color: #333;
    }
    .reset-button:hover {
        background-color: #e0e0e0;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="main-content">
    <div id="map"></div>

    <!-- Panel de filtros -->
    <div class="filter-panel">
        <h3>Filtros</h3>
        <div class="filter-group">
            <label for="startDate">Fecha Inicio:</label>
            <input type="date" id="startDate" name="startDate">
        </div>
        <div class="filter-group">
            <label for="endDate">Fecha Fin:</label>
            <input type="date" id="endDate" name="endDate">
        </div>
        <div class="filter-actions">
            <button class="filter-button apply-button" onclick="applyFilters()">Aplicar</button>
            <button class="filter-button reset-button" onclick="resetFilters()">Resetear</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
<script>
    // Inicializar variables globales
    let map;
    let markers = [];

    // Inicializar mapa
    mapboxgl.accessToken = '{{ mapbox_token }}';
    map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v11',
        center: [-64.0, -34.0],  // Centro en Argentina
        zoom: 4,
        transformRequest: (url, resourceType) => {
            if (resourceType === 'Source' || resourceType === 'Tile') {
                return {
                    url: url,
                    headers: {
                        'Accept-Language': 'es'  // Forzar español
                    }
                };
            }
        }
    });

    // Agregar el control de navegación
    map.addControl(new mapboxgl.NavigationControl());

    // Esperar a que el mapa cargue
    map.on('load', function() {
        // Personalizar el texto de las Malvinas
        map.setLayoutProperty('country-label', 'text-field', [
            'match',
            ['get', 'name_en'],
            'Falkland Islands (Islas Malvinas)',
            'Islas Malvinas',
            ['get', 'name']
        ]);

        // Cargar los marcadores de noticias
        loadNewsMarkers();
    });

    // Función para cargar y mostrar noticias
    async function loadNewsMarkers(filters = {}) {
        try {
            // Limpiar marcadores existentes
            clearMarkers();

            let url = '/api/news/locations';  
            if (filters.startDate || filters.endDate) {
                const params = new URLSearchParams();
                if (filters.startDate) params.append('start_date', filters.startDate);
                if (filters.endDate) params.append('end_date', filters.endDate);
                url += '?' + params.toString();
            }

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const newsLocations = await response.json();
            
            if (!Array.isArray(newsLocations)) {
                console.error('La respuesta no es un array:', newsLocations);
                return;
            }

            if (newsLocations.length === 0) {
                console.log('No se encontraron ubicaciones');
                return;
            }

            console.log('Ubicaciones encontradas:', newsLocations.length);

            // Agrupar noticias por ubicación
            const locationGroups = {};
            newsLocations.forEach(loc => {
                if (!loc.latitude || !loc.longitude) {
                    console.warn('Ubicación sin coordenadas:', loc);
                    return;
                }
                const key = `${loc.latitude},${loc.longitude}`;
                if (!locationGroups[key]) {
                    locationGroups[key] = [];
                }
                locationGroups[key].push(loc);
            });

            // Crear marcadores para cada grupo de ubicaciones
            Object.entries(locationGroups).forEach(([coords, locations]) => {
                const [lat, lng] = coords.split(',').map(Number);
                
                // Crear el contenido del popup
                let popupContent = '<div class="news-popup">';
                locations.forEach(loc => {
                    const date = loc.news.published_date ? new Date(loc.news.published_date).toLocaleDateString() : 'No disponible';
                    popupContent += `
                        <div class="news-item">
                            <h4>${loc.news.title}</h4>
                            <p>${loc.news.snippet || ''}</p>
                            <p class="source">Ubicación: ${loc.location_name}</p>
                            <p class="source">Fuente: ${loc.news.source || 'No disponible'}</p>
                            <p class="date">Fecha: ${date}</p>
                            ${loc.news.link ? `<a href="${loc.news.link}" target="_blank">Leer más</a>` : ''}
                        </div>
                        <hr>
                    `;
                });
                popupContent += '</div>';

                // Crear marcador
                const marker = new mapboxgl.Marker({
                    color: "#4a9eff",  // Color más visible para el tema oscuro
                    scale: 0.8  // Tamaño ligeramente más pequeño
                })
                .setLngLat([lng, lat])
                .setPopup(new mapboxgl.Popup().setHTML(popupContent))
                .addTo(map);

                markers.push(marker);
            });

        } catch (error) {
            console.error('Error loading news markers:', error);
        }
    }

    function clearMarkers() {
        markers.forEach(marker => marker.remove());
        markers = [];
    }

    function applyFilters() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        loadNewsMarkers({
            startDate: startDate,
            endDate: endDate
        });
    }

    function resetFilters() {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        loadNewsMarkers();
    }
</script>
{% endblock %}
